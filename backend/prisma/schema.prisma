generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                  String           @id @default(uuid())
  email               String           @unique
  passwordHash        String?
  assignedLevel       String
  unlockedLevels      String
  currentLessonId     String?
  totalPracticeTime   Int              @default(0)
  createdAt           DateTime         @default(now())
  name                String?
  city                String?
  state               String?
  age                 Int?
  photoUrl            String?
  stripeCustomerId    String?          @unique
  subscriptionStatus  String           @default("free")
  subscriptionEndDate DateTime?
  achievements        Achievement[]
  customDrills        CustomDrill[]
  dailyStreak         DailyStreak?
  drillResults        DrillResult[]
  orgMemberships      OrgMember[]
  spacedItems         SpacedItem[]
  trainingPlans       TrainingPlan[]
  goals               UserGoal[]
  preferences         UserPreferences?
  progress            UserProgress?
}

model DrillResult {
  id             String   @id @default(uuid())
  userId         String
  drillId        String
  grossWPM       Float
  netWPM         Float
  accuracy       Float
  durationMs     Int
  timestamp      DateTime @default(now())
  fatigueScore   Int?
  fatigueFlags   String?
  mode           String   @default("drill")
  idempotencyKey String?  @unique
  user           User     @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
  @@index([mode, timestamp])
}

model Organization {
  id                   String      @id @default(uuid())
  name                 String
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  planTier             String      @default("FREE")
  seatLimit            Int         @default(5)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?
  planStatus           String      @default("ACTIVE")
  currentPeriodEnd     DateTime?
  invites              OrgInvite[]
  members              OrgMember[]
}

model OrgMember {
  id        String       @id @default(uuid())
  orgId     String
  userId    String
  role      String
  createdAt DateTime     @default(now())
  user      User         @relation(fields: [userId], references: [id])
  org       Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
}

model OrgInvite {
  id         String       @id @default(uuid())
  orgId      String
  email      String
  role       String
  token      String       @unique
  expiresAt  DateTime
  createdAt  DateTime     @default(now())
  acceptedAt DateTime?
  org        Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
}

model SpacedItem {
  id         String   @id @default(uuid())
  userId     String
  drillId    String
  interval   Int
  repetition Int
  efactor    Float
  nextReview DateTime
  user       User     @relation(fields: [userId], references: [id])
}

model Achievement {
  id        String   @id @default(uuid())
  userId    String
  badgeType String
  earnedAt  DateTime @default(now())
  metadata  String?
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, badgeType])
}

model DailyStreak {
  id                String    @id @default(uuid())
  userId            String    @unique
  currentStreak     Int       @default(0)
  longestStreak     Int       @default(0)
  lastPracticeDate  DateTime?
  streakProtections Int       @default(0)
  user              User      @relation(fields: [userId], references: [id])
}

model CustomDrill {
  id         String   @id @default(uuid())
  userId     String
  title      String
  content    String
  difficulty String
  createdAt  DateTime @default(now())
  timesUsed  Int      @default(0)
  user       User     @relation(fields: [userId], references: [id])
}

model UserGoal {
  id           String    @id @default(uuid())
  userId       String
  goalType     String
  targetValue  Float
  currentValue Float     @default(0)
  deadline     DateTime?
  completed    Boolean   @default(false)
  createdAt    DateTime  @default(now())
  user         User      @relation(fields: [userId], references: [id])
}

model UserPreferences {
  id                String  @id @default(uuid())
  userId            String  @unique
  theme             String  @default("default")
  soundEnabled      Boolean @default(true)
  keyboardLayout    String  @default("qwerty")
  practiceReminders Boolean @default(false)
  reminderTime      String?
  user              User    @relation(fields: [userId], references: [id])
}

model KeyStats {
  id            String   @id @default(uuid())
  userId        String
  key           String
  attempts      Int      @default(0)
  correct       Int      @default(0)
  avgSpeed      Float    @default(0)
  lastPracticed DateTime @updatedAt

  @@unique([userId, key])
  @@index([userId])
}

model SequenceStats {
  id            String   @id @default(uuid())
  userId        String
  sequence      String
  type          String
  attempts      Int      @default(0)
  avgSpeed      Float    @default(0)
  lastPracticed DateTime @updatedAt

  @@unique([userId, sequence])
  @@index([userId, type])
}

model SessionDetails {
  id          String   @id @default(uuid())
  sessionId   String
  keystrokes  String
  liveMetrics String
  createdAt   DateTime @default(now())

  @@index([sessionId])
}

model UserProgress {
  id                String    @id @default(uuid())
  userId            String    @unique
  level             Int       @default(1)
  xp                Int       @default(0)
  totalPracticeTime Int       @default(0)
  dailyStreak       Int       @default(0)
  lastPracticeDate  DateTime?
  averageWPM        Float     @default(0)
  averageAccuracy   Float     @default(100)
  totalDrills       Int       @default(0)
  user              User      @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Recommendation {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  reason    String
  priority  Int
  content   String?
  dismissed Boolean  @default(false)
  completed Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, dismissed, completed])
}

model DailyChallenge {
  id             String   @id @default(uuid())
  date           DateTime @unique
  type           String
  content        String
  targetWPM      Int?
  targetAccuracy Int?
  targetTime     Int?
  xpReward       Int      @default(100)
}

model Certificate {
  id             String   @id @default(uuid())
  userId         String
  type           String
  wpm            Int
  accuracy       Int
  testDate       DateTime @default(now())
  certificateUrl String?

  @@index([userId])
}

model TrainingPlan {
  id            String        @id @default(uuid())
  userId        String
  track         String
  goalWpm       Int
  goalAccuracy  Int
  minutesPerDay Int           @default(20)
  startDate     DateTime      @default(now())
  endDate       DateTime?
  status        String        @default("ACTIVE")
  createdAt     DateTime      @default(now())
  days          TrainingDay[]
  user          User          @relation(fields: [userId], references: [id])

  @@index([userId, status])
}

model TrainingDay {
  id          String       @id @default(uuid())
  planId      String
  date        DateTime
  itemsJson       String
  completedItemIds String       @default("[]") // JSON array of completed item IDs
  status          String       @default("PLANNED")
  completedAt DateTime?
  createdAt   DateTime     @default(now())
  plan        TrainingPlan @relation(fields: [planId], references: [id])

  @@index([planId, date])
}
